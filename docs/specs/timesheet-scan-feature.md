# タイム記録表スキャン機能 仕様書

## 1. 概要

### 1.1 背景
水泳の練習現場では、コーチが手書きのタイム記録表に各選手のタイムを記録している。この手書きデータを SwimHub に手入力するのは時間がかかり、入力ミスも発生しやすい。AI Vision を活用し、記録表の画像からタイムを自動で読み取り、チームの練習ログとして登録する機能を提供する。

### 1.2 目的
- 手書きタイム記録表の入力作業を自動化
- 複数選手のタイムを一括でチーム練習ログに登録
- 入力ミスの削減と記録作業の効率化

### 1.3 対象ユーザー
- チームの管理者/コーチ

### 1.4 スコープ
- **対象**: Web版、チームの練習ログ記録のみ
- **対象画面**: `/teams-admin/[teamId]/practices/[practiceId]/logs`
- **対象データ**: `practice_logs` + `practice_times` テーブルのみ（Practice 自体は作成済み前提）
- **対象外**: モバイルアプリ（将来対応）、個人の練習ログ、大会記録（Record）、Practice テーブルの更新

---

## 2. ユーザーストーリー

```
AS A チームのコーチ/管理者
I WANT TO 手書きのタイム記録表を画像から読み取って練習ログに反映したい
SO THAT 手入力の手間を省き、正確にチーム全員のタイムを記録できる
```

---

## 3. 技術選定

### 3.1 AI Vision API
- **採用**: Google Gemini 2.5 Flash
- **理由**:
  - 無料枠あり（15RPM, 1Mトークン/日）→ 小規模チームならコスト0円
  - 手書き認識精度が高い（LLMベンチマークで上位）
  - Vision LLM のため画像から直接構造化JSONを返せる
  - 将来的に Gemini 2.5 Pro への切り替えも容易
- **コスト**: 入力 $0.15/Mトークン、出力 $0.60/Mトークン（1回あたり約$0.001）

### 3.2 バックエンド
- **Supabase Edge Function** (Deno runtime)
- Web アプリから画像(base64)を送信 → Edge Function で Gemini API を呼び出し → 構造化JSONを返却
- API キーをクライアントに露出させない
- 将来モバイル対応時にもそのまま利用可能

### 3.3 不採用とした選択肢
| 選択肢 | 不採用理由 |
|---|---|
| Google Cloud Vision (OCR) | テキスト抽出のみで表の構造を理解できない。正規表現パーサーが脆弱（cloud-visionブランチで実証済み） |
| Next.js API Route | Web専用になりモバイル展開時に再実装が必要 |
| クライアント直接呼び出し | API キーがブラウザに露出するセキュリティリスク |
| Claude Vision | 精度は高いがコストが Gemini の6倍。無料枠なし |

---

## 4. データフロー

```
┌──────────────┐     ┌──────────────────────┐     ┌─────────────┐
│ Web App      │     │ Supabase Edge Func   │     │ Gemini API  │
│              │     │                      │     │             │
│ 1. 画像選択   │────▶│ 2. 画像受信          │────▶│ 3. AI解析    │
│              │     │                      │     │             │
│ 4. 確認/修正  │◀────│    JSON返却           │◀────│   構造化JSON │
│              │     │                      │     │             │
│ 5. フォーム   │     │                      │     │             │
│    に反映     │     │                      │     │             │
│              │     │                      │     │             │
│ 6. 保存      │────▶│ 7. replace_practice   │     │             │
│  (既存処理)   │     │    _logs RPC         │     │             │
└──────────────┘     └──────────────────────┘     └─────────────┘
```

**ポイント**:
- Practice（日付、場所など）は作成済み。この機能が扱うのは PracticeLogs + PracticeTimes のみ。
- AI解析結果は既存の `PracticeLogClient` のフォームに反映する。保存処理は既存の `replace_practice_logs` RPC をそのまま利用する。

---

## 5. API 設計

### 5.1 Edge Function: `scan-timesheet`

**Endpoint**: `POST /functions/v1/scan-timesheet`

**Request**:
```typescript
// Headers
Authorization: Bearer <supabase_access_token>

// Body (JSON)
{
  "image": string  // base64エンコードされた画像データ
  "mimeType": "image/jpeg" | "image/png"
}
```

**Response**:
```typescript
{
  "menu": {
    "distance": 50,                 // 1本の距離(m)
    "repCount": 6,                  // 1セットあたりの本数
    "setCount": 3,                  // セット数
    "circle": 90,                   // サークルタイム(秒)、読み取れなければ null
    "description": "3s x 6 x 50m 1'30 ゴールセット" // セット説明（参考情報）
  },
  "swimmers": [
    {
      "no": 1,
      "name": "",                   // 読み取れない場合は空文字
      "style": "Br",               // 種目 (Fr/Br/Ba/Fly/IM)
      "times": [                    // 全本のタイム(秒)、読み取れない場合は null
        36.4, 36.9, 37.4, 37.8, 37.5, 37.2,
        37.4, 38.0, 37.5, 37.0, 37.4, 38.0,
        37.5, 36.8, 37.5, 37.6, 37.8, 37.5
      ]
    }
    // ... 他の選手
  ]
}
```

**Error Response**:
```typescript
{
  "error": "エラーメッセージ",
  "code": "PARSE_ERROR" | "IMAGE_ERROR" | "API_ERROR" | "AUTH_ERROR"
}
```

### 5.2 Gemini プロンプト設計

```
あなたは水泳のタイム記録表を読み取るアシスタントです。
手書きの記録表の画像から、以下の情報をJSON形式で抽出してください。

## ルール
- 3桁の数字（例: 364）は秒+コンマ秒に変換する（364 → 36.4）
- 種目の略称: Fr=自由形, Br=平泳ぎ, Ba=背泳ぎ, Fly=バタフライ, IM=個人メドレー
- 欄外のメタ情報（日付、場所、担当、セット説明）も識別する
- 読み取れない数字がある場合は null とする
- 名前が読み取れない場合は空文字とする
- セット平均やまとめの行は無視する（個別タイムのみ抽出）
- 赤文字・青文字の区別は不要（最速/最遅はタイムから算出）

## 出力形式
以下のJSON形式で出力してください。JSON以外のテキストは含めないでください。
{metadata: {...}, swimmers: [...]}
```

---

## 6. 画面設計

### 6.1 UXフロー

```
チーム管理画面
  └─ 練習一覧 → 練習をタップ
       └─ /teams-admin/[teamId]/practices/[practiceId]/logs
            └─ PracticeLogClient.tsx
                 ├─ 既存: メニュー追加・タイム入力フォーム
                 └─ 新規:「画像から練習記録を読み取る」ボタン
                      └─ OcrScanModal（モーダル）
                           ├─ Step 1: 画像アップロード
                           ├─ Step 2: AI解析中（ローディング）
                           └─ Step 3: 結果確認 → フォームに反映
```

### 6.2 OcrScanModal の設計

**トリガー**: PracticeLogClient 上部に「画像から練習記録を読み取る」ボタンを配置

#### Step 1: 画像アップロード
- ドラッグ&ドロップ or クリックでファイル選択
- 画像プレビュー表示
- ファイル形式チェック（JPEG, PNG）、サイズチェック（5MB以下）
- 「解析する」ボタン

#### Step 2: 解析中
- ローディングスピナー + 「画像を解析しています...」メッセージ
- キャンセルボタン

#### Step 3: 結果確認 + メンバー割り当て
- メニュー情報表示（距離、サークル、セット説明）
- 選手一覧テーブル:

```
┌────┬──────────────────────┬──────┬───────┬───────┬───────┬─── ───┬────────┐
│ No │ メンバー             │ 種目 │  1本目 │  2本目 │  3本目 │ ...  │  平均   │
├────┼──────────────────────┼──────┼───────┼───────┼───────┼──────┼────────┤
│  1 │ [▼ 田中太郎      ]  │  Br  │ 36.4  │ 36.9  │ 37.4  │ ...  │  37.4  │
│  2 │ [▼ 未選択        ]  │  Fr  │ 36.3  │ 36.0  │ 36.7  │ ...  │  35.6  │
│  3 │ [▼ 未選択        ]  │  Fr  │ 35.0  │ 35.6  │ 36.7  │ ...  │  36.8  │
└────┴──────────────────────┴──────┴───────┴───────┴───────┴──────┴────────┘
```

  - **メンバー列**: チームメンバーのプルダウン（必須）
    - AI が名前を読み取れた場合 → チームメンバーから候補を自動選択
    - 読み取れなかった場合 → 「未選択」状態（ユーザーがプルダウンで選択）
    - 既に他の行で選択済みのメンバーはグレーアウト（重複防止）
  - **タイム修正**: 各タイムセルをクリックして直接編集可能
    - null（読み取れなかった）セル → 黄色ハイライト + クリックで入力
    - 読み間違いのタイム → クリックして上書き修正
    - 修正後、平均・最速・最遅を自動再計算
  - 最速タイム → 赤文字、最遅タイム → 青文字
- 全選手のメンバー割り当てが完了するまで「フォームに反映」ボタンは非活性
- 「フォームに反映」ボタン / 「キャンセル」ボタン

### 6.3 フォーム反映ロジック

「フォームに反映」を押すと:
1. AI解析結果の各 swimmer を PracticeLogClient の `menus[]` に変換
   - 同じ種目の選手は1つのメニューにまとめる
   - style, distance, reps(=times.length), sets=1, circle を設定
   - targetUserIds にプルダウンで選択された user_id を設定
2. 各メニューの `times[]` (TeamTimeEntry) に選手ごとのタイムを設定
3. 既存メニューがある場合: 追加 or 上書きを確認ダイアログで選択

### 6.4 既存コンポーネントとの関係

| 既存コンポーネント | 役割 | 変更 |
|---|---|---|
| `PracticeLogClient.tsx` | メイン練習ログフォーム | ボタン追加 + OCR結果反映ロジック |
| `TeamTimeInputModal.tsx` | チームタイム入力モーダル | 変更なし（反映後の手動修正に利用） |
| `BaseModal.tsx` | モーダルベース | 変更なし（OcrScanModal で利用） |
| 新規: `OcrScanModal.tsx` | 画像スキャンモーダル | 新規作成 |

---

## 7. データマッピング

### 7.1 AI解析結果 → PracticeLogClient フォーム

| AI出力 | PracticeMenu フィールド | 備考 |
|---|---|---|
| swimmer.style | menu.style | 同じ種目の選手を1メニューにまとめる |
| menu.distance | menu.distance | |
| swimmers[].times.length | menu.reps | 本数 |
| 1（固定） | menu.sets | |
| menu.circle | menu.circleMin / circleSec | 秒→分秒に分解 |
| 'Swim' | menu.swimCategory | デフォルト |
| プルダウンで選択した user_id | menu.targetUserIds | |
| swimmer.times[i] | menu.times[] の TeamTimeEntry | userId + set_number=1 + rep_number + time |

### 7.2 チームメンバーとの紐付け（プルダウン選択）
- AI が名前を読み取れた場合 → team_members の display_name と部分一致で候補を自動選択
- 読み取れなかった / マッチしない場合 → 「未選択」状態
- ユーザーがプルダウンからチームメンバーを選択
- 全員の割り当てが完了するまでフォーム反映不可

---

## 8. エラーハンドリング

| エラーケース | 対応 |
|---|---|
| 画像が不鮮明 | 「読み取れませんでした。鮮明な画像で再試行してください」 |
| 一部のタイムが読み取れない | null として返却 → 確認画面で黄色ハイライト → 手動入力 |
| Gemini API エラー | リトライ1回 → 失敗なら「サーバーエラー」表示 |
| 認証エラー | エラーメッセージ表示 |
| ネットワークエラー | 「ネットワークエラーです。接続を確認してください」 |
| 画像サイズ超過（5MB以上） | アップロード前にバリデーション、エラー表示 |

---

## 9. 制約・制限事項

- **対応プラットフォーム**: Web版のみ（モバイルは将来対応）
- **対応画像**: JPEG, PNG
- **最大画像サイズ**: 5MB
- **最大選手数**: 1枚あたり10名程度（それ以上は精度低下の可能性）
- **対応フォーマット**: 表形式（横に本数、縦に選手）
- **Gemini 無料枠**: 15RPM, 1Mトークン/日（チーム利用でも十分な範囲）

---

## 10. 将来の拡張

| 機能 | 説明 | 優先度 |
|---|---|---|
| モバイル対応 | React Native アプリからも利用可能に（Edge Function共通） | 高 |
| 個人練習ログ対応 | 個人の練習記録画面でも利用可能に | 中 |
| 複数画像対応 | 2ページにまたがる記録表を連結して解析 | 低 |
| モデル切り替え | Gemini Pro / Claude への動的切り替え | 低 |

---

## 11. 実装 TODO

### Phase 1: バックエンド（Supabase Edge Function + Gemini API）

- [ ] **1.1** Supabase Edge Functions のセットアップ
  - `supabase/functions/scan-timesheet/index.ts` を作成
  - Deno runtime の初期設定
  - `supabase functions serve` でローカル動作確認

- [ ] **1.2** Gemini API 連携
  - Gemini 2.5 Flash の API キーを取得
  - Edge Function から Gemini Vision API を呼び出す処理を実装
  - base64画像 → Gemini に送信 → JSON レスポンス受信

- [ ] **1.3** プロンプト設計・チューニング
  - 構造化 JSON 出力用プロンプトを作成
  - 手書きタイム表のサンプル画像（3〜5枚）でテスト
  - 3桁数字 → 秒.コンマ秒変換の精度検証
  - エッジケース対応（読み取れない文字、斜め撮影など）

- [ ] **1.4** Edge Function の認証・バリデーション
  - Supabase Auth トークン検証
  - 画像サイズ/形式バリデーション（JPEG, PNG, 5MB以下）

- [ ] **1.5** Edge Function のデプロイ
  - `supabase secrets set GEMINI_API_KEY=xxx`
  - `supabase functions deploy scan-timesheet`
  - 本番環境での動作確認

---

### Phase 2: Web UI（OcrScanModal）

- [ ] **2.1** `OcrScanModal.tsx` の作成
  - BaseModal ベースのモーダルコンポーネント
  - 画像ドラッグ&ドロップ / ファイル選択UI
  - 画像プレビュー
  - ファイルバリデーション（形式、サイズ）

- [ ] **2.2** Edge Function 呼び出し
  - base64 エンコード → Edge Function に POST
  - ローディング UI
  - エラーハンドリング

- [ ] **2.3** 結果確認テーブル + メンバー割り当てUI
  - メニュー情報表示（距離、サークル、セット説明）
  - 選手×タイムのテーブル表示
  - 各行にチームメンバー選択プルダウン
    - AI名前マッチングで候補を自動選択
    - 選択済みメンバーのグレーアウト（重複防止）
  - 最速 → 赤文字、最遅 → 青文字、null → 黄色ハイライト
  - 全員割り当て完了まで「フォームに反映」ボタン非活性

---

### Phase 3: フォーム反映 + 保存

- [ ] **3.1** PracticeLogClient にボタン追加
  - 「画像から練習記録を読み取る」ボタン
  - OcrScanModal の開閉制御

- [ ] **3.2** OCR結果 → PracticeMenu 変換ロジック
  - swimmers[] → menus[] への変換
  - 同種目の選手を1メニューにグルーピング
  - チームメンバー名マッチング（name → user_id）
  - times[] → TeamTimeEntry[] への変換

- [ ] **3.3** フォーム反映
  - 既存メニューがある場合の追加/上書き確認
  - メニュー反映後、ユーザーが手動で確認・修正可能
  - 保存は既存の `replace_practice_logs` RPC をそのまま利用

---

### Phase 4: テスト・改善

- [ ] **4.1** Edge Function のテスト
  - サンプル画像での解析結果検証
  - 異常系テスト（不正画像、巨大画像、空画像）

- [ ] **4.2** E2E テスト
  - 画像アップロード → 解析 → 確認 → フォーム反映 → 保存の一連フロー
  - 保存後のデータ整合性確認

- [ ] **4.3** プロンプト改善
  - 実際のユーザー画像でテスト
  - 精度が低いパターンの特定と改善

---

### 実装順序の目安

```
Phase 1 (Edge Function)    ████████░░  3-4日
Phase 2 (OcrScanModal)     ██████░░░░  2-3日
Phase 3 (フォーム反映)      ██████░░░░  2-3日
Phase 4 (テスト・改善)      ████░░░░░░  1-2日
```

**合計: 約 8〜12日**

まずは Phase 1 で Edge Function + Gemini API の疎通を確認し、
実際の手書き画像での解析精度を検証するのが最優先。
